name: Notify docs config changes

on:
  push:
    paths:
      - "apps/web/app/[locale]/(main)/docs/docs-config.ts"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Build Discord payload
        id: build_payload
        run: |
          python <<'PY'
          import json
          import os
          import subprocess

          target = "apps/web/app/[locale]/(main)/docs/docs-config.ts"
          repository = os.environ.get("GITHUB_REPOSITORY", "")
          sha = os.environ.get("GITHUB_SHA", "")
          sha_short = sha[:7] if sha else ""
          branch = os.environ.get("GITHUB_REF_NAME") or os.environ.get("GITHUB_REF", "").split("/", 2)[-1]
          actor = os.environ.get("GITHUB_ACTOR", "unknown")
          commit_url = f"https://github.com/{repository}/commit/{sha}" if repository and sha else ""

          def run_git(args):
            return subprocess.run(
              ["git"] + args,
              check=False,
              capture_output=True,
              text=True,
            ).stdout.strip()

          commit_message = run_git(["log", "-1", "--pretty=%B"])
          if commit_message:
            commit_message = commit_message.strip()
            if len(commit_message) > 1000:
              commit_message = commit_message[:997] + "..."
          else:
            commit_message = "docs-config.ts が更新されました。"

          # diff fallback handling (initial commit, shallow clone, etc.)
          diff = run_git(["diff", "HEAD^", "HEAD", "--", target])
          if not diff:
            diff = run_git(["show", "HEAD", "--", target])

          diff = diff.strip()
          if diff:
            diff_clean = diff.replace("```", "`\u200b``")
            diff_block = f"```diff\n{diff_clean}\n```"
            if len(diff_block) > 1000:
              diff_block = diff_block[:997] + "..."
            diff_field = {
              "name": "Diff",
              "value": diff_block,
              "inline": False,
            }
          else:
            diff_field = None

          fields = [
            {
              "name": "コミット",
              "value": f"[`{sha_short}`]({commit_url})" if commit_url and sha_short else "N/A",
              "inline": True,
            },
            {
              "name": "ブランチ",
              "value": branch or "unknown",
              "inline": True,
            },
            {
              "name": "作者",
              "value": actor,
              "inline": True,
            },
          ]
          if diff_field:
            fields.append(diff_field)

          payload = {
            "content": "docs-config.ts が更新されました。",
            "embeds": [
              {
                "title": "docs-config.ts 更新",
                "url": commit_url or None,
                "description": commit_message,
                "color": 0x5865F2,
                "fields": fields,
              }
            ],
          }

          with open("payload.json", "w", encoding="utf-8") as file:
            json.dump(payload, file, ensure_ascii=False)
          PY

      - name: Send Discord notification
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://discord.com/api/webhooks/REPLACE_ME_ID/REPLACE_ME_TOKEN"
