---
title: Proxy.ts
createdAt: 2025-11-20
sponsors: true
---

Proxy は主にログイン状態に応じた画面のリダイレクトや翻訳など基盤にまつわる処理を行います。

```ts title=proxy.ts
import { getSessionCookie } from "better-auth/cookies";
import { type NextRequest, NextResponse } from "next/server";

const publicRoutes = ["/", /\/pets\/(?!new).*/];
const guestOnlyRoutes = [
  "/login",
  "/signup",
  "/reset-password",
  "/request-password-reset",
];

export async function proxy(request: NextRequest) {
  const sessionCookie = getSessionCookie(request);
  const pathname = request.nextUrl.pathname;
  const isPublicRoute = publicRoutes.some((route) => {
    if (typeof route === "string") {
      return route === pathname;
    }
    return route.test(pathname);
  });
  const isGuestRoute = guestOnlyRoutes.includes(pathname);
  const isPrivateRoute = !isGuestRoute && !isPublicRoute;

  if (isGuestRoute && sessionCookie) {
    const redirectTo = request.nextUrl.searchParams.get("redirect") || "/";
    return NextResponse.redirect(new URL(redirectTo, request.url));
  }

  if (isPrivateRoute && !sessionCookie) {
    const redirectUrl = new URL("/login", request.url);
    redirectUrl.searchParams.set("redirect", request.nextUrl.pathname);
    return NextResponse.redirect(redirectUrl);
  }

  return NextResponse.next();
}

export const config = {
  // API ルート、静的ファイル(static)、Next.jsの内部ファイル(_next)、および拡張子を含むパス（例: .png, .jpg, .css など）を除外し、全てのページルートにミドルウェアを適用します。
  // .*\\..* は「ドットを含む任意のファイル名（拡張子付きのファイル）」を意味します。
  matcher: "/((?!api|static|.*\\..*|_next).*)",
};
```

## ログイン状態に応じたリダイレクト

ほとんどの画面が要認証である場合、許可制のルート定義を行います。（保護したい画面ではなく、誰でもみれる画面を定義する）正規表現を用いることで特定のパス配下の画面をまとめて許可することもできます。

## matcher

明確な最適解がない状態ですが、現状最もシンプルなのは

- ルートハンドラー
- 静的ファイル
- 拡張子を含むURL

を除く指定です。

```ts
matcher: "/((?!api|static|.*\\..*|_next).*)",
```