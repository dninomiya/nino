---
title: 中規模のリストをブラウザにキャッシュし、クライアントでフィルタする
createdAt: 2025-11-12
sponsors: true
---

中規模かつ更新頻度の低いデータを検索する場合、Cache API で結果をキャッシュし、ブラウザで fuse.js を使って検索することでデータリクエストを減らし、高速な検索を実現できます。

[DEMO](/examples/browser-cache-client-filter)

## 概要

このアプローチは以下のような場合に有効です：

- **中規模のデータ**: 数百〜数千件程度のリスト
- **更新頻度が低い**: データが頻繁に変更されない
- **検索が頻繁**: ユーザーが頻繁に検索操作を行う
- **ネットワークリクエストを減らしたい**: サーバーへの負荷を軽減したい

### メリット

- **高速な検索**: ブラウザ内で検索するため、ネットワークレイテンシが発生しない
- **オフライン対応**: 一度キャッシュされれば、オフラインでも検索可能
- **サーバー負荷の軽減**: 検索リクエストがサーバーに到達しない
- **ユーザー体験の向上**: 即座に検索結果が表示される

## 必要な依存関係のインストール

:::code-group

```bash group=npm
npm install fuse.js nuqs
```

```bash group=pnpm
pnpm add fuse.js nuqs
```

```bash group=yarn
yarn add fuse.js nuqs
```

:::

## Cache API 用のヘルパー関数を作成

```ts title=lib/cache.ts
// キャッシュからデータを取得します。
export async function getCachedData(cacheName, url) {
  const cacheStorage = await caches.open(cacheName);
  const cachedResponse = await cacheStorage.match(url);

  if (!cachedResponse || !cachedResponse.ok) {
    return false;
  }

  return await cachedResponse.json();
}

// 古いキャッシュを削除して、ユーザーのディスク容量を尊重します。
export async function deleteOldCaches(currentCache) {
  const keys = await caches.keys();

  for (const key of keys) {
    const isOurCache = key.startsWith("todos-");
    if (currentCache === key || !isOurCache) {
      continue;
    }
    caches.delete(key);
  }
}

export async function getCacheVersion() {
  const cachedData = await db.query.todoSettings.findFirst();
  if (!cachedData) {
    return 1;
  }
  return cachedData.version;
}

export async function updateCacheVersion() {
  const cachedData = await db.query.todoSettings.findFirst();
  if (!cachedData) return;
  const newVersion = cachedData.version + 1;
  await db.update(todoSettings).set({ version: newVersion });
}
```

## データ取得関数を作成

```ts
// キャッシュからデータを取得しようとしますが、ない場合データベースから取得します。
async function getTodos(cacheVersion: number) {
  const cacheName = `todos-${cacheVersion}`;
  const url = "https://jsonplaceholder.typicode.com/todos/1";
  let cachedData = await getCachedData(cacheName, url);

  if (cachedData) {
    console.log("取得したキャッシュデータ");
    return cachedData;
  }

  console.log("最新データの取得");
  const cacheStorage = await caches.open(cacheName);
  await cacheStorage.add(url);
  cachedData = await getCachedData(cacheName, url);
  await deleteOldCaches(cacheName); // 古いキャッシュの削除

  return cachedData;
}
```

## データを取得し、fuse.js を使って検索する

```tsx
const fuse = new Fuse(todos, {
  keys: ["title", "description"],
  threshold: 0.3,
});

async function Page() {
  const cacheVersion = await getCacheVersion();
  const todos = await getTodos(cacheVersion);
  const [query, setQuery] = useQueryState("q");

  const results = useMemo(() => {
    return fuse.search(query);
  }, [query, fuse]);

  return (
    <div>
      <input type="text" placeholder="Search" onChange={(e) => {
        setQuery(e.target.value);
      }} />
      <ul>
        {results.map((result) => (
          <li key={result.item.id}>{result.item.title}</li>
        ))}
      </ul>
    </div>
  );
}
```

## データ更新時のバージョン更新

データの追加、削除、更新時に必ずキャッシュのバージョンを更新します。

```ts
"use server";

async function updateTodos() {
  // タスク更新処理

  await updateCacheVersion();
}
```